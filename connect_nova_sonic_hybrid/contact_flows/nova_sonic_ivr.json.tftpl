{
  "Version": "2019-10-30",
  "StartAction": "SetLogging",
  "Actions": [
    {
      "Identifier": "SetLogging",
      "Type": "UpdateLoggingBehavior",
      "Parameters": { "Behavior": "Enable" },
      "Transitions": { "NextAction": "SetVoice" }
    },
    {
      "Identifier": "SetVoice",
      "Type": "UpdateContactTextToSpeechVoice",
      "Parameters": { "TextToSpeechVoice": "Joanna" },
      "Transitions": { "NextAction": "StartStreaming" }
    },
    {
      "Identifier": "StartStreaming",
      "Type": "StartMediaStreaming",
      "Parameters": {
        "MediaStreamType": "Audio",
        "MediaStreamTrack": "FROM_CUSTOMER"
      },
      "Transitions": { "NextAction": "InvokeNovaSonic" }
    },
    {
      "Identifier": "InvokeNovaSonic",
      "Type": "InvokeLambdaFunction",
      "Parameters": {
        "FunctionArn": "${voice_lambda_arn}"
      },
      "Transitions": {
        "NextAction": "CheckQueueAttribute",
        "Errors": [
          { "NextAction": "PlayFallbackPrompt", "ErrorType": "NoMatchingError" }
        ]
      }
    },
    {
      "Identifier": "CheckQueueAttribute",
      "Type": "CheckContactAttributes",
      "Parameters": {
        "Attribute": "TargetQueue"
      },
      "Transitions": {
        "NextAction": "Disconnect",
        "Conditions": [
          %{ for index, name in keys(queues) ~}
          { "NextAction": "Transfer${name}", "Condition": { "Operator": "Equals", "Operands": ["${name}"] } }${ index < length(queues) - 1 ? "," : "" }
          %{ endfor ~}
        ]
      }
    },
    %{ for name, arn in queues ~}
    {
      "Identifier": "Transfer${name}",
      "Type": "TransferToQueue",
      "Parameters": { "QueueId": "${arn}" },
      "Transitions": { "NextAction": "Disconnect", "Errors": [{ "NextAction": "Disconnect", "ErrorType": "NoMatchingError" }] }
    },
    %{ endfor ~}
    {
      "Identifier": "PlayFallbackPrompt",
      "Type": "MessageParticipant",
      "Parameters": {
        "Text": "I am having trouble connecting to the intelligent assistant. Switching to our automated backup system."
      },
      "Transitions": { "NextAction": "InvokeLexFallback" }
    },
    {
      "Identifier": "InvokeLexFallback",
      "Type": "ConnectParticipantWithLexBot",
      "Parameters": {
        "LexV2BotName": "${lex_bot_name}",
        "LexV2BotAliasArn": "${lex_bot_alias_arn}"
      },
      "Transitions": {
        "NextAction": "CheckQueueAttribute",
        "Errors": [{ "NextAction": "Disconnect", "ErrorType": "NoMatchingError" }]
      }
    },
    {
      "Identifier": "Disconnect",
      "Type": "DisconnectParticipant",
      "Parameters": {},
      "Transitions": {}
    }
  ]
}
